{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- FIXED VERSION: Force Reload via SHELL REDIRECTION (QUOTED EOF) -->

<!-- Header -->
<header class="bg-dark py-5 mb-5">
    <div class="container px-4 px-lg-5 my-5">
        <div class="text-center text-white">
            <h1 class="display-4 fw-bolder">Your Shopping Cart</h1>
            <p class="lead fw-normal text-white-50 mb-0">Manage your items and proceed to checkout</p>
        </div>
    </div>
</header>

<div class="container mb-5">
    <div class="row g-5">
        <!-- Cart Items -->
        <div class="col-lg-8">
            {% if cart_products %}
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0 fw-bold">Cart Items ({{ cart|length }})</h5>
                </div>
                <div class="card-body p-0">
                    {% for item in cart %}
                    <div class="row align-items-center p-3 border-bottom g-3">
                        <!-- Product Image -->
                        <div class="col-md-2 col-4">
                            {% if item.product.image %}
                            <a href="{% url 'product' item.product.id %}">
                                <img src="{{ item.product.image.url }}" class="img-fluid rounded" alt="{{ item.product.name }}">
                            </a>
                            {% else %}
                            <a href="{% url 'product' item.product.id %}">
                                <img src="{% static 'assets/no_image.png' %}" class="img-fluid rounded opacity-50" alt="No image">
                            </a>
                            {% endif %}
                        </div>

                        <!-- Product Details -->
                        <div class="col-md-5 col-8">
                            <h5 class="fw-bold mb-1">
                                <a href="{% url 'product' item.product.id %}" class="text-decoration-none text-dark">{{ item.product.name }}</a>
                            </h5>
                            <p class="text-muted small mb-0 text-truncate">
                                {{ item.product.description|default:"No description" }}
                            </p>
                            <div class="mt-2">
                                {% if item.product.is_sale %}
                                <span class="text-danger fw-bold me-2">{{ item.product.sale_price }}€</span>
                                <span class="text-muted text-decoration-line-through small">{{ item.product.price }}€</span>
                                {% else %}
                                <span class="fw-bold">{{ item.product.price }}€</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Quantity & Actions -->
                        <div class="col-md-3 col-6">
                            <label class="small text-muted mb-1">Quantity</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select text-center" id="select{{ item.product.id }}">
                                    <!-- Manually inserted spaces for Django templates -->
                                    <option value="1" {% if item.quantity == 1 %}selected{% endif %}>1</option>
                                    <option value="2" {% if item.quantity == 2 %}selected{% endif %}>2</option>
                                    <option value="3" {% if item.quantity == 3 %}selected{% endif %}>3</option>
                                    <option value="4" {% if item.quantity == 4 %}selected{% endif %}>4</option>
                                    <option value="5" {% if item.quantity == 5 %}selected{% endif %}>5</option>
                                    <option value="6" {% if item.quantity == 6 %}selected{% endif %}>6</option>
                                    <option value="7" {% if item.quantity == 7 %}selected{% endif %}>7</option>
                                    <option value="8" {% if item.quantity == 8 %}selected{% endif %}>8</option>
                                    <option value="9" {% if item.quantity == 9 %}selected{% endif %}>9</option>
                                    <option value="10" {% if item.quantity == 10 %}selected{% endif %}>10</option>
                                    <!-- Keep current quantity if > 10 -->
                                    {% if item.quantity > 10 %}
                                    <option value="{{ item.quantity }}" selected>{{ item.quantity }}</option>
                                    {% endif %}
                                </select>
                                <button class="btn btn-outline-secondary update-cart" type="button" data-index="{{ item.product.id }}" title="Update Quantity">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Remove & Total -->
                        <div class="col-md-2 col-6 text-end">
                            <div class="fw-bold mb-2 h5">{{ item.total_price }}€</div>
                            <button type="button" data-index="{{ item.product.id }}" class="btn btn-sm btn-outline-danger remove-cart">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="text-center py-5 bg-light rounded shadow-sm">
                <i class="bi bi-cart-x display-1 text-muted mb-3 d-block"></i>
                <h3 class="fw-bold text-muted">Your cart is empty</h3>
                <p class="text-muted mb-4">Looks like you haven't added any books yet.</p>
                <a href="{% url 'home' %}" class="btn btn-primary btn-lg rounded-pill px-5">Start Shopping</a>
            </div>
            {% endif %}
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 position-sticky shadow-lg" style="top: 2rem;">
                <div class="card-header bg-light border-bottom py-3">
                    <h5 class="mb-0 fw-bold">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Subtotal</span>
                        <span class="fw-bold">{{ totals }}€</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">Shipping</span>
                        <span class="text-success">Free</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-4">
                        <span class="h5 fw-bold">Total</span>
                        <span class="h5 fw-bold text-primary">{{ totals }}€</span>
                    </div>

                    {% if cart_products %}
                    <div class="d-grid gap-2">
                        <a href="{% url 'checkout' %}" class="btn btn-primary btn-lg rounded-pill">Proceed to Checkout</a>
                        <a href="{% url 'home' %}" class="btn btn-outline-dark rounded-pill">Continue Shopping</a>
                    </div>
                    {% else %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-secondary btn-lg rounded-pill" disabled>Proceed to Checkout</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Update Cart
    $(document).on('click', '.update-cart', function (e) {
        e.preventDefault();
        var productid = $(this).data('index');
        var qty = $('#select' + productid + ' option:selected').val();

        $.ajax({
            url: '{% url "cart_update" %}',
            type: 'POST',
            data: {
                'product_id': productid,
                'product_qty': qty,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'action': 'post',
            },
            success: function (response) {
                location.reload();
            },
            error: function (response) {
                console.log(response);
            }
        });
    });

    // Remove from Cart
    $(document).on('click', '.remove-cart', function (e) {
        e.preventDefault();
        var productid = $(this).data('index');

        $.ajax({
            url: '{% url "cart_delete" %}',
            type: 'POST',
            data: {
                'product_id': productid,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'action': 'post',
            },
            success: function (response) {
                location.reload();
            },
            error: function (response) {
                console.log(response);
            }
        });
    });
</script>

{% endblock %}
