apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: libro-mind-gateway
  namespace: libro-mind
  annotations:
    # Use Nginx Ingress Controller
    kubernetes.io/ingress.class: nginx
    
    # --- Advanced API Gateway Features (NGINX) ---
    
    # 1. Rate Limiting (5 requests per second per IP)
    nginx.ingress.kubernetes.io/limit-rps: "5"
    
    # 2. CORS (Cross-Origin Resource Sharing)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, PUT, POST, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    
    # 3. Request Body Size Limit (Increase for file uploads)
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    
    # 4. SSL Redirect (force HTTPS if TLS is configured, disabled for localhost)
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

    # 5. Increase Timeouts for AI (300 seconds)
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"

spec:
  rules:
  - http:
      paths:
      # API Routes -> Backend
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 8000
      # Admin Routes -> Backend
      - path: /admin
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 8000
      # Static/Media -> Backend (if served by Django/Whitenoise directly, though often done via separate server)
      - path: /static
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 8000
      - path: /media
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 8000
      # Prometheus Metrics (Optional: protect this in prod)
      - path: /prometheus
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 8000
      # Frontend Application -> Next.js
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 3000
